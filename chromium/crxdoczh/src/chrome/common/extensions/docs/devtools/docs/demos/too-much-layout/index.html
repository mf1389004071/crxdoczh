{{+bindTo:partials.standard_devtools_article}}

<h1><!--@Timeline demo: Diagnosing forced synchronous layouts-->时间线演示：诊断强制同步布局</h1>

    <p><!--@This demo shows how you can use the Timeline to identify a kind of performance bottle-neck called 'forced synchronous layouts'. The demo application animates several images back and forth using-->该演示向您展示如何使用时间线找出一种称为“强制同步布局”的性能瓶颈。演示应用程序使用 <code><a href="http://docs.webplatform.org/wiki/dom/Window/requestAnimationFrame" _target="_blank">requestAnimationFrame()</a></code><!--@, the -->，即产生基于帧的动画的<a href="http://updates.html5rocks.com/2012/05/requestAnimationFrame-API-now-with-sub-millisecond-precision" target="_blank"><!--@recommended approach-->推荐方式</a><!--@ for performing frame-based animation. But there's a considerable amount of stuttering and jank as the animation runs We'll use the Timeline to diagnose what's going on.-->来回移动几张图片，但是动画运行时并不流畅。我们将使用时间线诊断哪里出了问题。</p>

   <p><!--@For more information about using Frames mode and forced asynchronous layouts see <a href="using-timeline.html#locating_forced_synchronous_layouts">Locating forced synchronous layouts</a> in <a href="/chrome-developer-tools/docs/using-timeline">Using the Timeline</a>.-->有关使用帧模式以及强制同步布局的更多信息请参见<a href="/devtools/docs/timeline">使用时间线</a>中的<a href="/devtools/docs/timeline#locating_forced_synchronous_layouts">寻找强制同步布局</a>。</p>

<div class="collapsible">
    <h2>
        <!--@Make a recording-->进行记录
    </h2>

    <p>
        <!--@First you'll make a recording of the animation.-->首先您要进行动画的记录。</p>
    <ol>
        <li><!--@Click <strong>Start</strong> to start the animation.-->单击<strong>开始</strong>开始动画。</li>
        <li><!--@Open the Timeline panel on this page, and go the Frames view.-->在当前网页上打开时间线面板，进入帧视图。</li>
        <li><!--@Click the Record button in the Timeline.-->单击时间线中的记录按钮。</li>
        <li><!--@After after a second or two (10-12 frames recorded) stop the recording and click <strong>Stop</strong> to stop the animation.-->一两秒后（记录了 10～12 帧）停止记录，并单击<strong>停止</strong>停止动画。</li>
    </ol>

<!--     <section class="expandable">
         <button type="button" class="button-red button expand-control" id="show-hide-1">Show/Hide Demo</button>
 -->
        <style>
            .mover {
                background: url("particle.png");
                height: 100px;
                width: 100px;
                position: absolute;
            }

            #toggle {
                width: 70px;
                height: 30px;
                font-weight: bold;
            }

        </style>

        <button id="toggle"><!--@Start-->开始</button>

        <div id="container">
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
                <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>
        <div class="mover"></div>

        </div>

        <script src="source.js"></script>        

</div>
<div class="collapsible">
    <h2><!--@Analyze the recording-->分析记录结果</h2>

    <p>
        <!--@Looking at the recording of the first few frames it's clear that each one is taking over 300ms to complete. If you hover your mouse over one of the frames a pop-up appears showing additional details about the frame.-->
        查看前几帧的记录，很明显每一帧要 300
        毫秒才能完成。如果您将鼠标悬停在其中一帧上，就会弹出窗口显示帧的其他详情。</p>

       <div class="screenshot"> <img src="images/frame-rate.png" alt=""></div>
    <p>
        <!--@Locate an Animation Frame Fired record and notice the yellow warning icon next to it, indicating a forced synchronous layout. The icon is slightly dimmed indicating that one of its child records contains the offending code, rather than this record itself. Expand the Animation Frame Fired to view its children.-->
        找到某一条 Animation Frame Fired 记录，注意到旁边的黄色警告图标，表示强制同步布局。图标以较浅的颜色显示，表示其中某一条子记录而不是记录本身包含相应的代码。展开 Animation Frame Fired 查看子记录。
    </p>

    <div class="screenshot"><img src="images/recording-1.png"></div>

    <p>
        <!--@The child records show a long, repeating pattern of <strong>Recalculate Style</strong> and <strong>Layout</strong> records. Each layout record is a result of the style recalculation that, in turn, is a result of the <code>requestAnimationFrame()</code> handler requesting the value of <code>offsetTop</code> for each image on the page. Hover your mouse over one of the Layout records and click the link for sources.js next to the Layout Forced property.-->
        子记录显示了一段不停反复的 <strong>Recalculate Style</strong>（重新计算样式）和
        <strong>Layout</strong>（布局）记录，每一次布局记录都是重新计算样式的结果，而重新计算样式又是
<code>requestAnimationFrame()</code> 处理程序请求网页上每一幅图片 <code>offsetTop</code>
的结果。将鼠标悬停在其中某一条布局记录上，并单击 Layout Forced 属性旁
sources.js 的链接。
    
    <div class="screenshot"><img src="images/layout-warning-hover.png"></div>
    
    <p>
        <!--@The Sources panel opens at line 43 of the source file at the <code>update()</code> function, which is the <code>requestAnimationCallback()</code> callback handler. The handler computes the image's <code>left</code> CSS style proeprty on the the image's <code>offsetTop</code> value. This forces Chrome to perform a new layout immediately to make sure it provides the correct value.-->
        源代码面板打开源文件 50 行所在的 <code>update()</code> 函数，也就是
<code>requestAnimationCallback()</code> 回调处理程序。该处理程序通过图片的
<code>offsetTop</code> 值计算图片的 <code>left</code> CSS 样式属性，强制
Chrome 浏览器立即进行新的布局过程，确保提供了准确的值。
    </p>

    <pre class="prettyprint lang-js">
// Animation loop
function update(timestamp) {
    for(var m = 0; m < movers.length; m++) {
        movers[m].style.left = ((Math.sin(movers[m].offsetTop + timestamp/1000)+1) * 500) + 'px';
        }
    raf = window.requestAnimationFrame(update);
};
</pre>

<p><!--@We know that forcing a page layout during every animation frame is slowing things down. Now we can try to fix the problem directly in DevTools.-->我们知道了在每一次动画帧中强制网页布局会使一切变慢，现在就可以直接在开发者工具中试着修复问题。</p>

</div>
<div class="collapsible">
    <h2><!--@Apply fix within DevTools-->在开发者工具中进行修复</h2>

    <p><!--@Now that we have an idea what's causing the performance issues, we can modify the JavaScript file directly in the Sources panel and test our changes right away.-->既然我们已经知道性能问题是什么导致的，就可以直接在源代码面板中修改
    JavaScript 文件，立即测试更改。</p>
    
    <ol>
        <li><!--@In the Sources panel that was opened previously, replace line 43 with the following code.-->在刚才打开的源代码面板中，将 50 行替换为以下代码。</li>
            <code style="prettyprint" lang-js><pre>movers[m].style.left = ((Math.sin(m + timestamp/1000)+1) * 500) + 'px';</pre></code>
            <p><!--@This version computes each image's <code>left</code> style property on its index in its holding array instead of on a layout-dependent property (<code>offsetWidth</code>).-->更改后的版本根据数组中的索引计算图片的
<code>left</code> 样式属性，而不是根据布局相关的属性（<code>offsetWidth</code>）。
            </p>

        <li><!--@Save your changes by pressing Cmd-S or Ctrl-S.-->按下 Cmd-S 或 Ctrl-S 保存更改。</li>
    </ol>

</div>
<div class="collapsible">
<h2><!--@Verify with another recording-->通过再一次记录确认</h2>

        <p><!--@The animation is clearly faster and smoother than before, but it's always good practice to measure the difference with another recording. It should look something like the recording below.-->显然动画比以前快多了，也流畅多了，但是再进行一次记录比较差异总是良好的做法。它应该如下面的记录所示。</p>

        <div class="screenshot"><img src="images/fixed.png"></div>

</div>
{{/partials.standard_devtools_article}}
